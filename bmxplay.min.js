!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.BmxPlay=t()}}(function(){return function t(e,r,n){function a(i,s){if(!r[i]){if(!e[i]){var u="function"==typeof require&&require;if(!s&&u)return u(i,!0);if(o)return o(i,!0);throw new Error("Cannot find module '"+i+"'")}var f=r[i]={exports:{}};e[i][0].call(f.exports,function(t){var r=e[i][1][t];return a(r?r:t)},f,f.exports,t,e,r,n)}return r[i].exports}for(var o="function"==typeof require&&require,i=0;i<n.length;i++)a(n[i]);return a}({1:[function(t,e,r){(function(t){"use strict";t===t.window&&t.URL&&t.Blob&&t.Worker?e.exports=function(){var e=["var timerIds = {}, _ = {};","_.setInterval = function(args) {","  timerIds[args.timerId] = setInterval(function() { postMessage(args.timerId); }, args.delay);","};","_.clearInterval = function(args) {","  clearInterval(timerIds[args.timerId]);","};","_.setTimeout = function(args) {","  timerIds[args.timerId] = setTimeout(function() { postMessage(args.timerId); }, args.delay);","};","_.clearTimeout = function(args) {","  clearTimeout(timerIds[args.timerId]);","};","onmessage = function(e) { _[e.data.type](e.data) };"].join(""),r=0,n={},a=new t.Worker(t.URL.createObjectURL(new t.Blob([e],{type:"text/javascript"})));return a.onmessage=function(t){n[t.data]&&n[t.data]()},{setInterval:function(t,e){return r+=1,a.postMessage({type:"setInterval",timerId:r,delay:e}),n[r]=t,r},setTimeout:function(t,e){return r+=1,a.postMessage({type:"setTimeout",timerId:r,delay:e}),n[r]=t,r},clearInterval:function(t){a.postMessage({type:"clearInterval",timerId:t}),n[t]=null},clearTimeout:function(t){a.postMessage({type:"clearTimeout",timerId:t}),n[t]=null}}}():e.exports=t}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(t,e,r){function n(){return{src:0,dst:0,amp:0,pan:0}}e.exports=n},{}],3:[function(t,e,r){function n(){this.type=0,this.numGlobalParameters=5,this.numTrackParameters=2,this.numChannels=2,this.pMasterInfo=null,this.xPos=0,this.yPos=0,this.buf=null,this.sources=0,this.scount=0,this.patterns=[],this.events=[],this.GlobalVals=new a,this.TrackVals=new a}var a=t("./ByteArray");n.prototype.Init=function(t){},n.prototype.Tick=function(){},n.prototype.Work=function(t,e,r){},n.prototype.getFreq=function(t){if(255!=t&&t>0){var e=12*(t>>4)+(15&t)-70;return 440*Math.pow(2,e/12)}return 0},n.prototype.getByte=function(t,e,r){if(null==t||e>=t.length)return r;var n=255&t.bytes.charCodeAt(e);return 255==n?r:n},n.prototype.gp=function(t,e){return n.prototype.getByte(this.GlobalVals,t,e)},n.prototype.tp=function(t,e){return n.prototype.getByte(this.TrackVals,t,e)},n.prototype.loadValues=function(t,e){if(!(null==this.patterns||this.patterns.length<=t)){var r=this.patterns[t];r.gdata.position=e*this.numGlobalParameters,r.gdata.readBytes(this.GlobalVals,0,this.numGlobalParameters),r.tdata.position=e*this.numTrackParameters,r.tdata.readBytes(this.TrackVals,0,this.numTrackParameters*r.numTracks)}},e.exports=n},{"./ByteArray":7}],4:[function(t,e,r){function n(){return{numRows:0,numTracks:0,gdata:new a,tdata:new a,sdata:new a}}var a=t("./ByteArray");e.exports=n},{"./ByteArray":7}],5:[function(t,e,r){var n=t("./BmxMachine"),a=t("./BmxConnection"),o=t("./BmxPattern"),i=t("./BmxSound"),s=t("./ByteArray"),u=[];u._xi=t("./_xi"),u._filter=t("./_filter"),u._delay=t("./_delay"),u._303=t("./_303");var f=function(){function t(t){return String.fromCharCode(t)}function e(e){return t(255&e)+t(e>>8&255)+t(e>>16&255)+t(e>>24&255)}function r(t,e){var r=new s;return r.length=e,r.length>0&&t.readBytes(r,0,r.length),r}function f(t){for(var e="";t.position<t.length;){var r=t.readByte();if(0==r)break;e+=String.fromCharCode(r)}return e}function c(t,e){for(var r=0;r<t.events.length;++r){var n=t.events[r],a=n[0],o=n[1];a==e&&o>=16&&(t.currentPattern=o-16,t.currentRow=0,t.patternRows=t.patterns[t.currentPattern].numRows)}this.SamplesPerTick=T,this.SamplesPerSec=g,t.currentRow<t.patternRows&&(t.loadValues(t.currentPattern,t.currentRow),t.Tick()),t.currentRow++}function l(t,e,r){if(0!=x.length){for(var n,a,o=0;o<x.length;++o){var i=x[o];i.scount=i.sources;for(var s=0;s<i.buf.length;++s)i.buf[s]=0}for(var u=0;0!=x[0].scount;)if(0!=x[u].scount||x[u].scount<0)u++;else{var i=x[u];i.Work(i.buf,r,i.numChannels);for(var f=0;f<P.length;++f){var c,l=P[f];if(l.src==u){c=x[l.dst];var p=l.amp/16384,d=l.pan/32768,m=1-d,y=p*m,v=p*d;n=i.buf,a=c.buf;var o,s=r;if(1==i.numChannels&&1==c.numChannels)for(;s--;)a[s]+=n[s]*p;else if(1==i.numChannels&&2==c.numChannels)for(var s=0,o=0;r>s;s++)a[o++]+=n[s]*y,a[o++]+=n[s]*v;else if(2==i.numChannels&&2==c.numChannels)for(var s=0,o=0;2*r>s;)a[o++]+=n[s++]*y,a[o++]+=n[s++]*v;c.scount--}}i.scount--,u=0}n=x[0].buf,a=t;for(var s=0,o=2*e;2*r>s;)a[o++]=h(n[s++])}}function h(t){return-32767>t?-32767:t>32767?32767:t}function p(t,e){for(var r=0,n=e,a=0,o=0;0!=n;){if(0==I){N&&N({pos:B,size:M});for(var i=0;i<x.length;++i){var s=x[i];c(s,B)}B++,B>=M&&(B=A)}a=T-I,r=n,r>W&&(r=W),r>a&&(r=a),I+=r,I==T&&(I=0),l(t,o,r),o+=r,n-=r}}function d(t){for(var e=O*q/32767,r=0,n=0;W>r;r++)t.data.getChannelData(0)[r]=j[n++]*e,t.data.getChannelData(1)[r]=j[n++]*e;p(j,W)}function m(){_=new i,g=_.GetSampleRate(),T=~~(60*g/(b*w)),k=g/T,W=_.GetBufferSize(),j=new Float32Array(2*W),_.addEventListener("sampleData",d)}function y(){for(var t=0;t<x.length;++t){var e=x[t];e.pMasterInfo={SamplesPerSec:g,SamplesPerTick:T},e.buf=new Float32Array(2*W),e.Init(C[t]),e.Tick()}}function v(){for(var t=0;2*W>t&&z<U.length;t++)U[z++]=j[t];var e=(U.length-z)/2;e>0?(p(j,e>=W?W:e),setTimeout(v,0)):E(U)}var g=44100,I=0,B=0,S=0,b=120,w=4,T=~~(60*g/(b*w)),k=g/T,x=[],P=[],C=[],M=0,A=0,R=0,G=0,_=null,F=null,V=!1,O=1,q=1,D=null,W=g,j=new Float32Array(2*W),L=new Uint8Array(W),N=null;this.Load=function(t){D=t,x=[],P=[],C=[];var i=V;this.Stop();var c=new s(t);if("Buzz"!=e(c.readInt()))return-1;for(var l=c.readInt(),h=0;l>h;++h){var d=c.readInt(),m=c.readInt(),v=(c.readInt(),c.position),F=e(d);switch(c.position=m,F){case"MACH":for(var O=c.readShort(),L=0;O>L;++L){var z=(f(c),c.readByte()),U=null;if(z==G)U=new n;else{var E=f(c);try{U=new u[E]}catch(H){console.log("Could not find class: "+E);break}}U.xPos=c.readFloat(),U.yPos=c.readFloat();var Q=c.readInt();if(Q>c.length)return console.log("machine data is too big, "+Q+" bytes"),-1;for(var Y=r(c,Q),J=c.readShort(),K=0;J>K;++K){f(c),c.readInt()}U.GlobalVals=r(c,U.numGlobalParameters);var X=c.readShort();U.TrackVals=r(c,U.numTrackParameters*X),U.sources=0,U.buf=null,U.patterns=[],U.events=[],x.push(U),C.push(Y),z==G&&(q=1-(U.gp(0)+256*U.gp(1))/16384)}break;case"CONN":var Z=c.readShort();for(L=0;Z>L;L++){var $=a();for($.src=c.readShort(),$.dst=c.readShort(),$.amp=c.readShort(),$.pan=c.readShort(),P.push($),rt=0;rt<x.length;++rt)$.dst==rt&&x[rt].sources++}break;case"PATT":;for(L=0;L<x.length;L++)for(var U=x[L],tt=c.readShort(),et=c.readShort(),rt=0;tt>rt;rt++){var nt=o();for(nt.numTracks=et,nt.name=f(c),nt.numRows=c.readShort(),K=0;K<U.sources;++K)c.readShort(),r(c,2*nt.numRows*2);nt.gdata=r(c,U.numGlobalParameters*nt.numRows),nt.tdata=r(c,U.numTrackParameters*nt.numRows*nt.numTracks),U.patterns.push(nt)}break;case"SEQU":M=c.readInt(),A=c.readInt(),R=c.readInt();var at=c.readShort();for(L=0;at>L;L++){var ot=c.readShort(),U=x[ot],it=c.readInt(),st=c.readByte(),ut=c.readByte();for(rt=0;it>rt;rt++){var ft=1==st?255&c.readByte():c.readShort(),ct=1==ut?255&c.readByte():c.readShort(),lt=[ft,ct];U.events.push(lt)}}}c.position=v}return b=x[0].gp(2),w=x[0].gp(4),T=~~(60*g/(b*w)),I=0,B=0,k=~~(g/T),S=16,_&&(y(),p(j,W)),i&&this.Play(),N&&N({pos:0,size:M}),0},this.SetCallback=function(t){N=t},this.IsPlaying=function(){return V},this.Play=function(){if(!V){if(!_){try{m()}catch(t){return void alert("Web Audio is not supported")}y(),p(j,W)}V=!0,F=_.play()}return V},this.Stop=function(){return V&&(V=!1,F.stop()),V},this.SetPos=function(t){_&&(B=t,I=0,p(j,W))},this.SetMasterVolume=function(t){q=t},this.SetVolume=function(t){O=t},this.GetOscData=function(t,e,r){return L.byteLength!=e&&(L=new Uint8Array(e)),_&&_.GetOscData(L,t,e,r),L},this.Reload=function(){I=0,B=0,this.Load(D),_||(y(),p(j,W))};var z=0,U=null,E=null;this.Render=function(t,e){E=t,this.Stop(),this.Reload();var r=2,n=T*M*r*(e?e:1),a=23;U=new Uint16Array(a+n),U[0]=18770,U[1]=17990,U[2]=2*n+15&65535,U[3]=(2*n+15&4294901760)>>16,U[4]=16727,U[5]=17750,U[6]=28006,U[7]=8308,U[8]=18,U[9]=0,U[10]=1,U[11]=r,U[12]=65535&g,U[13]=(4294901760&g)>>16,U[14]=2*r*g&65535,U[15]=(2*r*g&4294901760)>>16,U[16]=4,U[17]=16,U[18]=0,U[19]=24932,U[20]=24948,U[21]=2*n&65535,U[22]=(2*n&4294901760)>>16,z=a,v()}};e.exports=f},{"./BmxConnection":2,"./BmxMachine":3,"./BmxPattern":4,"./BmxSound":6,"./ByteArray":7,"./_303":8,"./_delay":9,"./_filter":10,"./_xi":11}],6:[function(t,e,r){function n(){function t(){var t=n.currentTime;t>=d&&(d+=p,l[h].connect(n.destination),l[h].connect(o),l[h].start(d),h=(h+1)%u,l[h]=n.createBufferSource(),r({data:c[h]}),l[h].buffer=c[h])}for(var e=!1,r=null,n=new(window.AudioContext||window.webkitAudioContext),o=n.createAnalyser(),i=n.sampleRate/4,s=2*i,u=3,f=2,c=[],l=[],h=0;u>h;h++)c[h]=n.createBuffer(f,s,n.sampleRate),l[h]=n.createBufferSource();var h=0;l[h]=n.createBufferSource(),l[h].buffer=c[h];var p=i/n.sampleRate,d=n.currentTime;this.addEventListener=function(t,e){r=e};var m;this.play=function(){return e||(e=!0,d=n.currentTime,m=a.setInterval(t,125)),{stop:function(){e=!1,a.clearInterval(m)}}},this.GetSampleRate=function(){return n.sampleRate},this.GetBufferSize=function(){return i},this.GetOscData=function(t,e,r,n){r=Math.pow(2,Math.round(Math.log(r)/Math.log(2))),o.fftSize=r,n&&(o.smoothingTimeConstant=n),1==e?o.getByteFrequencyData(t):o.getByteTimeDomainData(t)}}var a=t("worker-timer");e.exports=n},{"worker-timer":1}],7:[function(t,e,r){function n(t){this.bytes=t||"",this.length=this.bytes.length,this.position=0}n.prototype.bytesAvailable=function(){return this.length-this.position},n.prototype.readByte=function(){var t=255&this.bytes.charCodeAt(this.position++);return t>127?t-256:t},n.prototype.readBytes=function(t){for(var e="",r=0;t>r;r++)e+=String.fromCharCode(this.readByte());return e},n.prototype.readBytes=function(t,e,r){t.bytes="";for(var n=0;r>n;n++)t.bytes+=String.fromCharCode(this.readByte());return t},n.prototype.readInt=function(){return 255&this.readByte()|(255&this.readByte())<<8|(255&this.readByte())<<16|(255&this.readByte())<<24},n.prototype.readShort=function(){return 255&this.readByte()|(255&this.readByte())<<8},n.prototype.readFloat=function(){var t=this.readInt(),e=2147483648&t?-1:1,r=(t>>23&255)-127,n=8388607&t;if(128==r)return e*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127==r){if(0==n)return 0*e;r=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return e*n*Math.pow(2,r)},e.exports=n},{}],8:[function(t,e,r){function n(){this.type=1,this.numGlobalParameters=6,this.numTrackParameters=3,this.numChannels=1;var t,e,r,n,a,o,i,s,u,f,c,l,h,p,d,m,y,v,g,I,B,S,b,w,T,k,x,P;this.Init=function(f){t=64,e=64,r=0,n=0,a=64,o=0,i=0,s=0,u=0},this.Tick=function(){if(t=this.gp(0,t),e=this.gp(1,e),r=this.gp(2,r),n=this.gp(3,n),a=this.gp(4,a),o=this.gp(5,o),i=this.tp(0,i),s=this.tp(1,s),u=this.tp(2,u),T=a/128,0!=i&&(d=this.getFreq(i+t-64),0!=d&&(f=0,v=-32767,I=this.pMasterInfo.SamplesPerSec/d,B=0,b=1,w=-(1/this.pMasterInfo.SamplesPerTick*T),y=0,g=65536/I,c=h,l=p,x=0,P=0,S=w*c,k=c)),0!=u&&(m=this.getFreq(u+t-64),0!=d&&0!=s)){var C=this.pMasterInfo.SamplesPerSec/m,M=1/this.pMasterInfo.SamplesPerTick/s;B=(C-I)*M,w=-M,S=w*c}h=e/128*.98+.1,p=r/128*.88},this.Work=function(t,e,r){if(0==d)return!1;for(var n=0;e>n;++n)if(b>0){var a=v*b,o=l+l/(1-c);x+=c*(a-x+o*(x-P)),P+=c*(x-P),c+=S,t[n]=P,I+=B,f++,f>=I&&(f=0,v=-32767),v+=g,b+=w}else t[n]=0;return!0}}var a=t("./BmxMachine");n.prototype=Object.create(a.prototype),n.prototype.constructor=n,e.exports=n},{"./BmxMachine":3}],9:[function(t,e,r){function n(){this.type=1,this.numGlobalParameters=4,this.numTrackParameters=0,this.numChannels=2;var t,e,r,n,a,o,i,s,u,f,c,l,h;this.Init=function(o){t=45,e=93,r=128,n=103,f=0,a=0,c=this.pMasterInfo.SamplesPerSec,l=new Float32Array(c),h=new Float32Array(c)},this.Tick=function(){t=this.gp(0,t),e=this.gp(1,e),r=this.gp(2,r),n=this.gp(3,n),o=t/128,i=e/128,s=r/128,u=n/128},this.Work=function(t,e,r){for(var n=o*c,p=f?l:h,d=f?h:l,m=0;2*e>m;){var y=t[m];t[m++]=d[a]*u+y*s,d[a]=i*d[a],t[m++]=p[a]*u+y*s,p[a]=y+i*p[a],a++,a>=n&&(a=0,f=1-f,p=f?l:h,d=f?h:l)}return!0}}var a=t("./BmxMachine");n.prototype=Object.create(a.prototype),n.prototype.constructor=n,e.exports=n},{"./BmxMachine":3}],10:[function(t,e,r){function n(){this.type=1,this.numGlobalParameters=3,this.numTrackParameters=0,this.numChannels=1;var t,e,r,n,a,o,i,s,u;this.Init=function(n){t=128,e=0,r=0,i=0,s=0,u=this.pMasterInfo.SamplesPerSec/44100},this.Tick=function(){t=this.gp(0,t),e=this.gp(1,e),r=this.gp(2,r),n=t/128*.99*u,a=e/128*.98*u,o=r/128*u},this.Work=function(t,e,r){for(var u=0;e>u;++u){var f=t[u],c=a+a/(1-n);if(i+=n*(f-i+c*(i-s)),s+=n*(i-s),t[u]=s,0!=o){var l=1/(1-o),h=t[u];h*=l,h>32767?h=32767:-32767>h&&(h=-32767),t[u]=h}}return!0}}var a=t("./BmxMachine");n.prototype=Object.create(a.prototype),n.prototype.constructor=n,e.exports=n},{"./BmxMachine":3}],11:[function(t,e,r){function n(){function t(){if(0==i)return 0;var t=w;if(t==i)return x=!1,0;var e=h[t].x;if(S+=T,S>=e&&e>b){e=h[t+1].x;var r=h[t+1].y/64;B=(r-I)*T/(e-S),w++}else I+=B;return b=S,I}this.type=1,this.numGlobalParameters=0,this.numTrackParameters=1,this.numChannels=1;var e,r,n,a,o,i,s,u,f,c,l,h,p,d,m,y,v,g,I,B,S,b,w,T,k,x;this.Init=function(t){if(e=0,n=0,x=!1,y=-1,m=261.7,i=0,h=[],p=null,t&&t.length){r=t.readInt(),n=t.readInt(),a=t.readInt(),o=t.readInt(),i=t.readByte();for(var d=0;12>d;d++)h.push({x:t.readShort(),y:t.readShort()});if(s=t.readByte(),u=t.readByte(),f=t.readByte(),c=t.readByte(),l=t.readByte(),t.readInt(),t.readInt(),p=new Int8Array(n),1==f)for(var v=0;n/2>v&&0!=t.bytesAvailable;++v){var g=t.readByte(),I=(15&g)<<4,B=240&g;p[2*v+0]=I>127?I-256:I,p[2*v+1]=B>127?B-256:B}else for(var v=0;n>v;++v)p[v]=t.readByte()}},this.Tick=function(){e=this.tp(0,e),0!=e&&(d=this.getFreq(e),y=0,v=~~(256*d/m*44100/this.pMasterInfo.SamplesPerSec),this.startenv(),x=!0)},this.Work=function(e,r,i){if(0==m||-1==y)return!1;for(var s=0;r>s;++s){var f=~~(y/256);if(n-1>f&&x){var c=p[f],l=p[f+1];g=256*c+(l-c)*(255&y),e[s]=0==u?g:g*t(),k=(y+v)/256,1==u&&k>=a+o&&(y=256*a),2==u&&(k>=a+o-1?v=-v:a>=k&&0>v&&(v=-v))}else e[s]=0;y+=v}return!0},this.startenv=function(){return 0==i?0:(B=0,S=0,b=-1,T=6/this.pMasterInfo.SamplesPerTick,I=h[0].y/64,void(w=0))}}var a=t("./BmxMachine");n.prototype=Object.create(a.prototype),n.prototype.constructor=n,e.exports=n},{"./BmxMachine":3}]},{},[5])(5)});
