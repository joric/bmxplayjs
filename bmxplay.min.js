!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.BmxPlay=t()}}(function(){return function t(e,r,n){function a(i,s){if(!r[i]){if(!e[i]){var u="function"==typeof require&&require;if(!s&&u)return u(i,!0);if(o)return o(i,!0);throw new Error("Cannot find module '"+i+"'")}var f=r[i]={exports:{}};e[i][0].call(f.exports,function(t){var r=e[i][1][t];return a(r?r:t)},f,f.exports,t,e,r,n)}return r[i].exports}for(var o="function"==typeof require&&require,i=0;i<n.length;i++)a(n[i]);return a}({1:[function(t,e){(function(t){"use strict";e.exports=t===t.window&&t.URL&&t.Blob&&t.Worker?function(){var e=["var timerIds = {}, _ = {};","_.setInterval = function(args) {","  timerIds[args.timerId] = setInterval(function() { postMessage(args.timerId); }, args.delay);","};","_.clearInterval = function(args) {","  clearInterval(timerIds[args.timerId]);","};","_.setTimeout = function(args) {","  timerIds[args.timerId] = setTimeout(function() { postMessage(args.timerId); }, args.delay);","};","_.clearTimeout = function(args) {","  clearTimeout(timerIds[args.timerId]);","};","onmessage = function(e) { _[e.data.type](e.data) };"].join(""),r=0,n={},a=new t.Worker(t.URL.createObjectURL(new t.Blob([e],{type:"text/javascript"})));return a.onmessage=function(t){n[t.data]&&n[t.data]()},{setInterval:function(t,e){return r+=1,a.postMessage({type:"setInterval",timerId:r,delay:e}),n[r]=t,r},setTimeout:function(t,e){return r+=1,a.postMessage({type:"setTimeout",timerId:r,delay:e}),n[r]=t,r},clearInterval:function(t){a.postMessage({type:"clearInterval",timerId:t}),n[t]=null},clearTimeout:function(t){a.postMessage({type:"clearTimeout",timerId:t}),n[t]=null}}}():t}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(t,e){function r(){return{src:0,dst:0,amp:0,pan:0}}e.exports=r},{}],3:[function(t,e){function r(){this.type=0,this.numGlobalParameters=5,this.numTrackParameters=2,this.numChannels=2,this.pMasterInfo=null,this.xPos=0,this.yPos=0,this.buf=null,this.sources=0,this.scount=0,this.patterns=[],this.events=[],this.GlobalVals=new n,this.TrackVals=new n}var n=t("./ByteArray");r.prototype.Init=function(){},r.prototype.Tick=function(){},r.prototype.Work=function(){},r.prototype.getFreq=function(t){if(255!=t&&t>0){var e=12*(t>>4)+(15&t)-70;return 440*Math.pow(2,e/12)}return 0},r.prototype.getByte=function(t,e,r){if(null==t||e>=t.length)return r;var n=255&t.bytes.charCodeAt(e);return 255==n?r:n},r.prototype.gp=function(t,e){return r.prototype.getByte(this.GlobalVals,t,e)},r.prototype.tp=function(t,e){return r.prototype.getByte(this.TrackVals,t,e)},r.prototype.loadValues=function(t,e){if(!(null==this.patterns||this.patterns.length<=t)){var r=this.patterns[t];r.gdata.position=e*this.numGlobalParameters,r.gdata.readBytes(this.GlobalVals,0,this.numGlobalParameters),r.tdata.position=e*this.numTrackParameters,r.tdata.readBytes(this.TrackVals,0,this.numTrackParameters*r.numTracks)}},e.exports=r},{"./ByteArray":7}],4:[function(t,e){function r(){return{numRows:0,numTracks:0,gdata:new n,tdata:new n,sdata:new n}}var n=t("./ByteArray");e.exports=r},{"./ByteArray":7}],5:[function(t,e){var r=t("./BmxMachine"),n=t("./BmxConnection"),a=t("./BmxPattern"),o=t("./BmxSound"),i=t("./ByteArray"),s=[];s._xi=t("./_xi"),s._filter=t("./_filter"),s._delay=t("./_delay"),s._303=t("./_303");var u=function(){function t(t){return String.fromCharCode(t)}function e(e){return t(255&e)+t(e>>8&255)+t(e>>16&255)+t(e>>24&255)}function u(t,e){var r=new i;return r.length=e,r.length>0&&t.readBytes(r,0,r.length),r}function f(t){for(var e="";t.position<t.length;){var r=t.readByte();if(0==r)break;e+=String.fromCharCode(r)}return e}function c(t,e){for(var r=0;r<t.events.length;++r){var n=t.events[r],a=n[0],o=n[1];a==e&&o>=16&&(t.currentPattern=o-16,t.currentRow=0,t.patternRows=t.patterns[t.currentPattern].numRows)}this.SamplesPerTick=T,this.SamplesPerSec=g,t.currentRow<t.patternRows&&(t.loadValues(t.currentPattern,t.currentRow),t.Tick()),t.currentRow++}function l(t,e,r){if(0!=x.length){for(var n,a,o=0;o<x.length;++o){var i=x[o];i.scount=i.sources;for(var s=0;s<i.buf.length;++s)i.buf[s]=0}for(var u=0;0!=x[0].scount;)if(0!=x[u].scount||x[u].scount<0)u++;else{var i=x[u];i.Work(i.buf,r,i.numChannels);for(var f=0;f<P.length;++f){var c,l=P[f];if(l.src==u){c=x[l.dst];var p=l.amp/16384,d=l.pan/32768,m=1-d,y=p*m,v=p*d;n=i.buf,a=c.buf;var o,s=r;if(1==i.numChannels&&1==c.numChannels)for(;s--;)a[s]+=n[s]*p;else if(1==i.numChannels&&2==c.numChannels)for(var s=0,o=0;r>s;s++)a[o++]+=n[s]*y,a[o++]+=n[s]*v;else if(2==i.numChannels&&2==c.numChannels)for(var s=0,o=0;2*r>s;)a[o++]+=n[s++]*y,a[o++]+=n[s++]*v;c.scount--}}i.scount--,u=0}n=x[0].buf,a=t;for(var s=0,o=2*e;2*r>s;)a[o++]=h(n[s++])}}function h(t){return-32767>t?-32767:t>32767?32767:t}function p(t,e){for(var r=0,n=e,a=0,o=0;0!=n;){if(0==B){j&&j({pos:I,size:M});for(var i=0;i<x.length;++i){var s=x[i];c(s,I)}I++,I>=M&&(I=A)}a=T-B,r=n,r>q&&(r=q),r>a&&(r=a),B+=r,B==T&&(B=0),l(t,o,r),o+=r,n-=r}}function d(t){for(var e=1/32767,r=0,n=0;q>r;r++)t.data.getChannelData(0)[r]=D[n++]*e,t.data.getChannelData(1)[r]=D[n++]*e;p(D,q)}function m(){_=new o,g=_.GetSampleRate(),q=_.GetBufferSize(),D=new Float32Array(2*q),_.addEventListener("sampleData",d)}function y(){for(var t=0;t<x.length;++t){var e=x[t];e.pMasterInfo={SamplesPerSec:g,SamplesPerTick:T},e.buf=new Float32Array(2*q),e.Init(C[t]),e.Tick()}}function v(){for(var t=0;2*q>t&&L<N.length;t++)N[L++]=D[t];var e=(N.length-L)/2;e>0?(p(D,e>=q?q:e),setTimeout(v,0)):z(N)}var g=44100,B=0,I=0,b=0,w=120,S=4,T=~~(60*g/(w*S)),k=g/T,x=[],P=[],C=[],M=0,A=0,R=0,G=0,_=null,F=null,V=!1,O=null,q=g,D=new Float32Array(2*q),W=new Uint8Array(q),j=null;this.Load=function(t){O=t,x=[],P=[],C=[];var o=V;this.Stop();var c=new i(t);if("Buzz"!=e(c.readInt()))return-1;for(var l=c.readInt(),h=0;l>h;++h){var d=c.readInt(),m=c.readInt(),v=(c.readInt(),c.position),F=e(d);switch(c.position=m,F){case"MACH":for(var W=c.readShort(),L=0;W>L;++L){var N=(f(c),c.readByte()),z=null;if(N==G)z=new r;else{var U=f(c);try{z=new s[U]}catch(E){console.log("Could not find class: "+U);break}}z.xPos=c.readFloat(),z.yPos=c.readFloat();var H=c.readInt();if(H>c.length)return console.log("machine data is too big, "+H+" bytes"),-1;for(var Q=u(c,H),Y=c.readShort(),J=0;Y>J;++J){f(c),c.readInt()}z.GlobalVals=u(c,z.numGlobalParameters);var K=c.readShort();z.TrackVals=u(c,z.numTrackParameters*K),z.sources=0,z.buf=null,z.patterns=[],z.events=[],x.push(z),C.push(Q)}break;case"CONN":var X=c.readShort();for(L=0;X>L;L++){var Z=n();for(Z.src=c.readShort(),Z.dst=c.readShort(),Z.amp=c.readShort(),Z.pan=c.readShort(),P.push(Z),ee=0;ee<x.length;++ee)Z.dst==ee&&x[ee].sources++}break;case"PATT":;for(L=0;L<x.length;L++)for(var z=x[L],$=c.readShort(),te=c.readShort(),ee=0;$>ee;ee++){var re=a();for(re.numTracks=te,re.name=f(c),re.numRows=c.readShort(),J=0;J<z.sources;++J)c.readShort(),u(c,2*re.numRows*2);re.gdata=u(c,z.numGlobalParameters*re.numRows),re.tdata=u(c,z.numTrackParameters*re.numRows*re.numTracks),z.patterns.push(re)}break;case"SEQU":M=c.readInt(),A=c.readInt(),R=c.readInt();var ne=c.readShort();for(L=0;ne>L;L++){var ae=c.readShort(),z=x[ae],oe=c.readInt(),ie=c.readByte(),se=c.readByte();for(ee=0;oe>ee;ee++){var ue=1==ie?255&c.readByte():c.readShort(),fe=1==se?255&c.readByte():c.readShort(),ce=[ue,fe];z.events.push(ce)}}}c.position=v}return w=x[0].gp(2),S=x[0].gp(4),T=~~(60*g/(w*S)),B=0,I=0,k=~~(g/T),b=16,_&&(y(),p(D,q)),o&&this.Play(),j&&j({pos:0,size:M}),0},this.SetCallback=function(t){j=t},this.IsPlaying=function(){return V},this.Play=function(){if(!V){if(!_){try{m()}catch(t){return void alert("Web Audio is not supported")}y(),p(D,q)}V=!0,F=_.play()}return V},this.Stop=function(){return V&&(V=!1,F.stop()),V},this.SetPos=function(t){_&&(I=t,B=0,p(D,q))},this.GetOscData=function(t,e,r){return W.byteLength!=e&&(W=new Uint8Array(e)),_&&_.GetOscData(W,t,e,r),W},this.Reload=function(){B=0,I=0,this.Load(O),_||(y(),p(D,q))};var L=0,N=null,z=null;this.Render=function(t,e){z=t,this.Stop(),this.Reload();var r=2,n=T*M*r*(e?e:1),a=23;N=new Uint16Array(a+n),N[0]=18770,N[1]=17990,N[2]=2*n+15&65535,N[3]=(2*n+15&4294901760)>>16,N[4]=16727,N[5]=17750,N[6]=28006,N[7]=8308,N[8]=18,N[9]=0,N[10]=1,N[11]=r,N[12]=65535&g,N[13]=(4294901760&g)>>16,N[14]=2*r*g&65535,N[15]=(2*r*g&4294901760)>>16,N[16]=4,N[17]=16,N[18]=0,N[19]=24932,N[20]=24948,N[21]=2*n&65535,N[22]=(2*n&4294901760)>>16,L=a,v()}};e.exports=u},{"./BmxConnection":2,"./BmxMachine":3,"./BmxPattern":4,"./BmxSound":6,"./ByteArray":7,"./_303":8,"./_delay":9,"./_filter":10,"./_xi":11}],6:[function(t,e){function r(){function t(){var t=a.currentTime;t>=d&&(d+=p,l[h].connect(a.destination),l[h].connect(o),l[h].start(d),h=(h+1)%u,l[h]=a.createBufferSource(),r({data:c[h]}),l[h].buffer=c[h])}for(var e=!1,r=null,a=new(window.AudioContext||window.webkitAudioContext),o=a.createAnalyser(),i=a.sampleRate/4,s=2*i,u=3,f=2,c=[],l=[],h=0;u>h;h++)c[h]=a.createBuffer(f,s,a.sampleRate),l[h]=a.createBufferSource();var h=0;l[h]=a.createBufferSource(),l[h].buffer=c[h];var p=i/a.sampleRate,d=a.currentTime;this.addEventListener=function(t,e){r=e};var m;this.play=function(){return e||(e=!0,d=a.currentTime,m=n.setInterval(t,125)),{stop:function(){e=!1,n.clearInterval(m)}}},this.GetSampleRate=function(){return a.sampleRate},this.GetBufferSize=function(){return i},this.GetOscData=function(t,e,r,n){r=Math.pow(2,Math.round(Math.log(r)/Math.log(2))),o.fftSize=r,n&&(o.smoothingTimeConstant=n),1==e?o.getByteFrequencyData(t):o.getByteTimeDomainData(t)}}var n=t("worker-timer");e.exports=r},{"worker-timer":1}],7:[function(t,e){function r(t){this.bytes=t||"",this.length=this.bytes.length,this.position=0}r.prototype.bytesAvailable=function(){return this.length-this.position},r.prototype.readByte=function(){var t=255&this.bytes.charCodeAt(this.position++);return t>127?t-256:t},r.prototype.readBytes=function(t){for(var e="",r=0;t>r;r++)e+=String.fromCharCode(this.readByte());return e},r.prototype.readBytes=function(t,e,r){t.bytes="";for(var n=0;r>n;n++)t.bytes+=String.fromCharCode(this.readByte());return t},r.prototype.readInt=function(){return 255&this.readByte()|(255&this.readByte())<<8|(255&this.readByte())<<16|(255&this.readByte())<<24},r.prototype.readShort=function(){return 255&this.readByte()|(255&this.readByte())<<8},r.prototype.readFloat=function(){var t=this.readInt(),e=2147483648&t?-1:1,r=(t>>23&255)-127,n=8388607&t;if(128==r)return e*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127==r){if(0==n)return 0*e;r=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return e*n*Math.pow(2,r)},e.exports=r},{}],8:[function(t,e){function r(){this.type=1,this.numGlobalParameters=6,this.numTrackParameters=3,this.numChannels=1;var t,e,r,n,a,o,i,s,u,f,c,l,h,p,d,m,y,v,g,B,I,b,w,S,T,k,x,P;this.Init=function(){t=64,e=64,r=0,n=0,a=64,o=0,i=0,s=0,u=0},this.Tick=function(){if(t=this.gp(0,t),e=this.gp(1,e),r=this.gp(2,r),n=this.gp(3,n),a=this.gp(4,a),o=this.gp(5,o),i=this.tp(0,i),s=this.tp(1,s),u=this.tp(2,u),T=a/128,0!=i&&(d=this.getFreq(i+t-64),0!=d&&(f=0,v=-32767,B=this.pMasterInfo.SamplesPerSec/d,I=0,w=1,S=-(1/this.pMasterInfo.SamplesPerTick*T),y=0,g=65536/B,c=h,l=p,x=0,P=0,b=S*c,k=c)),0!=u&&(m=this.getFreq(u+t-64),0!=d&&0!=s)){var C=this.pMasterInfo.SamplesPerSec/m,M=1/this.pMasterInfo.SamplesPerTick/s;I=(C-B)*M,S=-M,b=S*c}h=e/128*.98+.1,p=r/128*.88},this.Work=function(t,e){if(0==d)return!1;for(var r=0;e>r;++r)if(w>0){var n=v*w,a=l+l/(1-c);x+=c*(n-x+a*(x-P)),P+=c*(x-P),c+=b,t[r]=P,B+=I,f++,f>=B&&(f=0,v=-32767),v+=g,w+=S}else t[r]=0;return!0}}var n=t("./BmxMachine");r.prototype=Object.create(n.prototype),r.prototype.constructor=r,e.exports=r},{"./BmxMachine":3}],9:[function(t,e){function r(){this.type=1,this.numGlobalParameters=4,this.numTrackParameters=0,this.numChannels=2;var t,e,r,n,a,o,i,s,u,f,c,l,h;this.Init=function(){t=45,e=93,r=128,n=103,f=0,a=0,c=this.pMasterInfo.SamplesPerSec,l=new Float32Array(c),h=new Float32Array(c)},this.Tick=function(){t=this.gp(0,t),e=this.gp(1,e),r=this.gp(2,r),n=this.gp(3,n),o=t/128,i=e/128,s=r/128,u=n/128},this.Work=function(t,e){for(var r=o*c,n=f?l:h,p=f?h:l,d=0;2*e>d;){var m=t[d];t[d++]=p[a]*u+m*s,p[a]=i*p[a],t[d++]=n[a]*u+m*s,n[a]=m+i*n[a],a++,a>=r&&(a=0,f=1-f,n=f?l:h,p=f?h:l)}return!0}}var n=t("./BmxMachine");r.prototype=Object.create(n.prototype),r.prototype.constructor=r,e.exports=r},{"./BmxMachine":3}],10:[function(t,e){function r(){this.type=1,this.numGlobalParameters=3,this.numTrackParameters=0,this.numChannels=1;var t,e,r,n,a,o,i,s;this.Init=function(){t=128,e=0,r=0,i=0,s=0},this.Tick=function(){t=this.gp(0,t),e=this.gp(1,e),r=this.gp(2,r),n=t/128*.99,a=e/128*.98,o=r/128},this.Work=function(t,e){for(var r=0;e>r;++r){var u=t[r],f=a+a/(1-n);if(i+=n*(u-i+f*(i-s)),s+=n*(i-s),t[r]=s,0!=o){var c=1/(1-o),l=t[r];l*=c,l>32767?l=32767:-32767>l&&(l=-32767),t[r]=l}}return!0}}var n=t("./BmxMachine");r.prototype=Object.create(n.prototype),r.prototype.constructor=r,e.exports=r},{"./BmxMachine":3}],11:[function(t,e){function r(){function t(){if(0==i)return 0;var t=S;if(t==i)return x=!1,0;var e=h[t].x;if(b+=T,b>=e&&e>w){e=h[t+1].x;var r=h[t+1].y/64;I=(r-B)*T/(e-b),S++}else B+=I;return w=b,B}this.type=1,this.numGlobalParameters=0,this.numTrackParameters=1,this.numChannels=1;var e,r,n,a,o,i,s,u,f,c,l,h,p,d,m,y,v,g,B,I,b,w,S,T,k,x;this.Init=function(t){if(e=0,n=0,x=!1,y=-1,m=261.7,i=0,h=[],p=null,t&&t.length){r=t.readInt(),n=t.readInt(),a=t.readInt(),o=t.readInt(),i=t.readByte();for(var d=0;12>d;d++)h.push({x:t.readShort(),y:t.readShort()});if(s=t.readByte(),u=t.readByte(),f=t.readByte(),c=t.readByte(),l=t.readByte(),t.readInt(),t.readInt(),p=new Int8Array(n),1==f)for(var v=0;n/2>v&&0!=t.bytesAvailable;++v){var g=t.readByte(),B=(15&g)<<4,I=240&g;p[2*v+0]=B>127?B-256:B,p[2*v+1]=I>127?I-256:I}else for(var v=0;n>v;++v)p[v]=t.readByte()}},this.Tick=function(){e=this.tp(0,e),0!=e&&(d=this.getFreq(e),y=0,v=~~(256*d/m),this.startenv(),x=!0)},this.Work=function(e,r){if(0==m||-1==y)return!1;for(var i=0;r>i;++i){var s=~~(y/256);if(n-1>s&&x){var f=p[s],c=p[s+1];g=256*f+(c-f)*(255&y),e[i]=0==u?g:g*t(),k=(y+v)/256,1==u&&k>=a+o&&(y=256*a),2==u&&(k>=a+o-1?v=-v:a>=k&&0>v&&(v=-v))}else e[i]=0;y+=v}return!0},this.startenv=function(){return 0==i?0:(I=0,b=0,w=-1,T=6/this.pMasterInfo.SamplesPerTick,B=h[0].y/64,void(S=0))}}var n=t("./BmxMachine");r.prototype=Object.create(n.prototype),r.prototype.constructor=r,e.exports=r},{"./BmxMachine":3}]},{},[5])(5)});